---

- name: Setup Virtual Environment and Install Dependencies
  ansible.builtin.pip:
    requirements: "{{ pulumi_requirements }}"
    virtualenv: "{{ pulumi_workdir }}/{{ pulumi_venv_name }}"
    virtualenv_command: /usr/bin/python3 -m venv
    chdir: "{{ pulumi_workdir }}"
  register: venv_setup

# 1. 先檢查檔案是否存在
- name: "Check if Python Venv Exists"
  ansible.builtin.stat:
    path: "{{ pulumi_venv_bin }}/python"
  register: venv_check

# 2. 如果不存在，使用 fail 模組報錯並顯示訊息
- name: "Verify Python Venv Exists"
  ansible.builtin.fail:
    msg: "Python venv not found! Please run setup first."
  when: not venv_check.stat.exists