---
# 1. [通用] 還是先抓 Pulumi Output JSON
#    為什麼？因為 EKS 那邊還是需要 Cluster Name (除非您也把 Cluster Name 存 SSM 了)
- name: Fetch Stack Outputs [{{ current_stack_full_name }}]
  ansible.builtin.command: >-
    pulumi stack output --json --stack {{ current_stack_full_name }}
  args:
    chdir: "{{ pulumi_workdir }}"
  environment: "{{ pulumi_env }}"
  register: stack_output_json
  changed_when: false

- name: Parse Outputs
  ansible.builtin.set_fact:
    current_outputs: "{{ stack_output_json.stdout | from_json }}"

# ==============================================================================
# Case A: EKS Stack -> 更新 Kubeconfig (維持原樣)
# ==============================================================================
- name: Configure Kubeconfig (EKS Only)
  ansible.builtin.command: >-
    aws eks update-kubeconfig 
    --name {{ current_outputs.cluster_name }} 
    --region ap-northeast-1 
    --alias {{ current_outputs.cluster_name }}
  environment: "{{ pulumi_env }}"
  when: current_outputs.cluster_name is defined

