- name: Get Bucket Name from Pulumi
  command: >
    pulumi stack output bucket_name 
    --cwd {{ pulumi_workdir }} 
    --stack edge-{{ pulumi_stack }}
  register: s3_bucket_output
  changed_when: false

# 2. åŒæ­¥æª”æ¡ˆ
- name: Sync Assets to S3
  command: >
    aws s3 sync 
    {{ static_local_src }} 
    s3://{{ s3_bucket_output.stdout }}/{{ static_s3_dest_prefix }}
    {{ static_sync_opts }}
    --cache-control "{{ static_cache_control }}"
  delegate_to: localhost
  environment:
    # ğŸ’¡ é—œéµï¼šç¢ºä¿å‚³å…¥é€™äº›è®Šæ•¸ï¼ŒAWS CLI æ‰æœƒç›´æ¥ä½¿ç”¨å®ƒå€‘è€Œä¸å»æ‰¾ Profile
    AWS_ACCESS_KEY_ID: "{{ lookup('env', 'AWS_ACCESS_KEY_ID') }}"
    AWS_SECRET_ACCESS_KEY: "{{ lookup('env', 'AWS_SECRET_ACCESS_KEY') }}"
    AWS_SESSION_TOKEN: "{{ lookup('env', 'AWS_SESSION_TOKEN') }}"
    AWS_REGION: "{{ aws_region }}"
    AWS_PROFILE: ""
  register: sync_result
  changed_when: "'upload:' in sync_result.stdout"