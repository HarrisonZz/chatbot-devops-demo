---

- name: Check kubeconfig path exists
  ansible.builtin.stat:
    path: "{{ kubeconfig | expanduser }}"
  register: kubeconfig_stat

- name: Fail if kubeconfig not found
  ansible.builtin.fail:
    msg: "❌ kubeconfig not found at: {{ kubeconfig }}"
  when: not kubeconfig_stat.stat.exists

- name: Query cluster nodes
  kubernetes.core.k8s_info:
    kubeconfig: "{{ kubeconfig }}"
    context: "{{ kubecontext | default(omit, true) }}"
    api_version: v1
    kind: Node
  register: k8s_nodes
  ignore_errors: true

- name: Verify API Connectivity
  ansible.builtin.fail:
    msg: "❌ Failed to connect to EKS API. DNS is fine, so check your IAM Role or Network."
  when: k8s_nodes.failed | default(false)

- name: Count Ready nodes (Strict Check)
  ansible.builtin.set_fact:
    ready_nodes: >-
      {{
        k8s_nodes.resources | default([]) |
        json_query("[?status.conditions[?type=='Ready' && status=='True']]") |
        length
      }}