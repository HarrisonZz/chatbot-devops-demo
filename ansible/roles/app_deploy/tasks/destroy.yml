---
  - name: Force enable ArgoCD cascade delete via finalizer
    ansible.builtin.command: >
      kubectl -n {{ argocd_namespace }}
      patch application {{ item }}
      --type merge
      -p '{"metadata":{"finalizers":["resources-finalizer.argocd.argoproj.io"]}}'
    loop: "{{ argocd_apps_to_delete }}"
    changed_when: true
    failed_when: false   # 有些 app 可能不存在，別讓它炸整段
  
  - name: Delete ArgoCD Applications (stop GitOps reconciliation)
    kubernetes.core.k8s:
      state: absent
      api_version: argoproj.io/v1alpha1
      kind: Application
      namespace: "{{ argocd_namespace }}"
      name: "{{ item }}"
    loop: "{{ argocd_apps_to_delete }}"
    ignore_errors: true

  - name: 1. 刪除 Kubernetes Ingress (觸發 ALB 銷毀)
    kubernetes.core.k8s:
      state: absent
      definition:
        apiVersion: networking.k8s.io/v1
        kind: Ingress
        metadata:
          name: ai-chatbot-ingress
          namespace: default
    register: ingress_delete
    until: ingress_delete is succeeded
    retries: 3
    delay: 10

  - name: 2. 等待 AWS ALB 實體完全消失 (選用)
    amazon.aws.elb_application_lb_info:
      region: ap-northeast-1
      names:
        - "{{ alb_fixed_name }}" # 這裡可以根據名稱規律動態匹配
    register: alb_info
    until: alb_info.network_load_balancers | length == 0
    retries: 15
    delay: 20
    ignore_errors: yes