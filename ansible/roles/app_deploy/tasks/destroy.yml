---

  - name: Ensure Python kubernetes library is installed
    ansible.builtin.pip:
      name: kubernetes
      state: present
      # ðŸ’¡ å¼·åˆ¶æŒ‡å®šä½¿ç”¨ pip3ï¼Œé€šå¸¸èƒ½å°æ‡‰åˆ°ç³»çµ±é è¨­çš„ python3
      executable: pip3 
    # ç¢ºä¿é€™æ˜¯åœ¨åŸ·è¡Œ Ansible çš„é‚£å°æ©Ÿå™¨ (ä½ çš„å®¹å™¨) ä¸ŠåŸ·è¡Œï¼Œè€Œä¸æ˜¯é ç«¯ç›®æ¨™
    delegate_to: localhost 
    run_once: true

  - name: Check if kubeconfig file exists
    stat:
      path: "~/.kube/config"
    register: kubeconfig_check

  - name: Update Kubeconfig with Specific Profile
    ansible.builtin.command: >-
      aws eks update-kubeconfig 
      --name {{ eks_cluster_name }} 
      --region {{ aws_region }}
      --kubeconfig {{ kubeconfig | expanduser }}
    environment: "{{ pulumi_env | default({}) }}"
    vars:
      # ç¢ºä¿é€™è£¡ä½¿ç”¨ç³»çµ±çš„ AWS CLIï¼Œä¸å— Python ç’°å¢ƒå½±éŸ¿
      ansible_python_interpreter: "/usr/bin/python3" 
    when: not kubeconfig_check.stat.exists

  - name: Delete ArgoCD Applications (stop GitOps reconciliation)
    kubernetes.core.k8s:
      kubeconfig: "{{ kubeconfig }}"
      state: absent
      api_version: argoproj.io/v1alpha1
      kind: Application
      namespace: "{{ argocd_namespace }}"
      name: "{{ item }}"
    loop: "{{ argocd_apps_to_delete }}"
    ignore_errors: false

  - name: Destroy [addons-{{ pulumi_stack }}]
    ansible.builtin.command: >-
      pulumi destroy --stack addons-{{ pulumi_stack }} --yes
    args:
      chdir: "{{ pulumi_workdir }}"
    environment: "{{ pulumi_env }}"