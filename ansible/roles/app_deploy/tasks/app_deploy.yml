---

- name: Check if kubeconfig file exists
  ansible.builtin.stat:
    path: "{{ kubeconfig | expanduser }}"
  register: kubeconfig_check

- name: Update Kubeconfig with Specific Profile
  ansible.builtin.command: >-
    aws eks update-kubeconfig 
    --name {{ eks_cluster_name }} 
    --region {{ aws_region }}
    --kubeconfig {{ kubeconfig | expanduser }}
  environment: "{{ pulumi_env | default({}) }}"
  vars:
    # ç¢ºä¿é€™è£¡ä½¿ç”¨ç³»çµ±çš„ AWS CLIï¼Œä¸å— Python ç’°å¢ƒå½±éŸ¿
    ansible_python_interpreter: "/usr/bin/python3" 
  when: not kubeconfig_check.stat.exists
  
- name: Bootstrap ArgoCD Resources (Projects & Apps)
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig | default('~/.kube/config') }}"
    src: "{{ item }}"  # ğŸ‘ˆ ç›´æ¥æŒ‡å®šæª”æ¡ˆè·¯å¾‘ï¼Œè®“æ¨¡çµ„è‡ªå·±å»è®€
    state: present
  with_fileglob:
    # ğŸ‘‡ ä¸€æ¬¡æŠŠæ‰€æœ‰è¦ä½ˆç½²çš„æª”æ¡ˆè·¯å¾‘éƒ½åˆ—å‡ºä¾†
    - "{{ playbook_dir }}/../../k8s/argocd/projects/*.yaml"
    - "{{ playbook_dir }}/../../k8s/argocd/root/*.yaml"