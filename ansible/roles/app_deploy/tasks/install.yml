---

- name: Add Helm Repositories
  kubernetes.core.helm_repository:
    name: "{{ item.name }}"
    repo_url: "{{ item.url }}"
  loop:
    - { name: argo, url: "https://argoproj.github.io/argo-helm" }
    - { name: stakater, url: "https://stakater.github.io/stakater-charts" }

- name: Update Kubeconfig with Specific Profile
  ansible.builtin.command: >-
    aws eks update-kubeconfig 
    --name {{ eks_cluster_name }} 
    --region {{ aws_region }}
    --kubeconfig {{ kubeconfig | expanduser }}
  environment: "{{ pulumi_env | default({}) }}"
  vars:
    # 確保這裡使用系統的 AWS CLI，不受 Python 環境影響
    ansible_python_interpreter: "/usr/bin/python3" 
  when: update_kubeconfig | default(true)

- name: "Run Pulumi Preview addons-{{ pulumi_stack }}"
  ansible.builtin.shell: |
    set -euo pipefail
    pulumi preview --stack addons-{{ pulumi_stack }}
  args:
    chdir: "{{ pulumi_workdir }}"
    executable: /bin/bash
  register: preview_output
  changed_when: false

# 2. 顯示結果
- name: Show Preview Result
  ansible.builtin.debug:
    var: preview_output.stdout_lines
  when: preview_output.stdout_lines is defined

- name: Up [addons-{{ pulumi_stack }}]
  ansible.builtin.command: >-
    pulumi up --stack addons-{{ pulumi_stack }} --yes --skip-preview
  args:
    chdir: "{{ pulumi_workdir }}"
  environment: "{{ pulumi_env }}"
  
- name: Ensure namespaces exist
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig | expanduser }}"
    context: "{{ kubecontext | default(omit, true) }}"
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ item }}"
  environment: "{{ pulumi_env | default({}) }}"
  loop:
    - "{{ argocd_namespace }}"
    - "{{ reloader_namespace }}"

- name: Add Argo Helm repo
  kubernetes.core.helm_repository:
    name: argo
    repo_url: https://argoproj.github.io/argo-helm
    state: present
  # ⚠️ 很重要：避免你其他 task 有 become 造成 repo 加到不同 HOME
  become: false

- name: Update Helm repo cache
  ansible.builtin.command: helm repo update
  changed_when: false
  become: false

- name: Install ArgoCD
  kubernetes.core.helm:
    kubeconfig: "{{ kubeconfig }}"
    name: argocd
    chart_ref: argo/argo-cd
    release_namespace: "{{ argocd_namespace }}"
    chart_version: "{{ argocd_chart_version | default('9.1.7') }}"
    update_repo_cache: yes
    values:
      # 資源優化：開發環境關閉 HA
      redis-ha:
        enabled: "{{ argocd_ha_enabled | default(false) }}"
      controller:
        replicas: "{{ 1 if not (argocd_ha_enabled | default(false)) else 2 }}"
      repoServer:
        replicas: "{{ 1 if not (argocd_ha_enabled | default(false)) else 2 }}"
      applicationSet:
        replicas: "{{ 1 if not (argocd_ha_enabled | default(false)) else 2 }}"
      
      # 網路設定：直接開 LoadBalancer 方便連線
      server:
        service:
          type: "{{ argocd_service_type | default('ClusterIP') }}"
        # 禁止 Helm 安裝時自帶的 Ingress，避免跟我們自己的 Ingress Controller 打架
        ingress:
          enabled: false
  environment: "{{ pulumi_env | default({}) }}"
  when: argocd_enabled | default(true)

- name: Add Stakater Helm repo
  kubernetes.core.helm_repository:
    name: "{{ reloader_repo_name | default('stakater') }}"
    repo_url: "{{ reloader_repo_url | default('https://stakater.github.io/stakater-charts') }}"
    state: present
  become: false

- name: Update Helm repo cache
  ansible.builtin.command: helm repo update
  changed_when: false
  become: false

- name: Install Reloader
  kubernetes.core.helm:
    kubeconfig: "{{ kubeconfig | expanduser }}"
    name: reloader
    chart_ref: stakater/reloader
    release_namespace: "{{ reloader_namespace }}" # 通常放在工具類 namespace
    values:
      # 讓它監控所有 Namespaces 裡的 ConfigMap/Secret 變更
      reloader:
        watchGlobally: true
  environment: "{{ pulumi_env | default({}) }}"
  when: reloader_enabled | default(true)