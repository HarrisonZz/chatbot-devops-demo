- name: Validate required vars
  ansible.builtin.assert:
    that:
      - (not eso_enabled) or (eso_irsa_role_arn | length > 0)
    fail_msg: "âŒ eso_irsa_role_arn is required when eso_enabled=true. Did fetch_facts.yml run successfully?"

- name: Add Helm Repositories
  kubernetes.core.helm_repository:
    name: "{{ item.name }}"
    repo_url: "{{ item.url }}"
  loop:
    - { name: argo, url: "https://argoproj.github.io/argo-helm" }
    - { name: external-secrets, url: "https://charts.external-secrets.io" }
    - { name: stakater, url: "https://stakater.github.io/stakater-charts" }

- name: Update Kubeconfig with Specific Profile
  ansible.builtin.command: >-
    aws eks update-kubeconfig 
    --name {{ eks_cluster_name }} 
    --region {{ aws_region }}
    --kubeconfig {{ kubeconfig | expanduser }}
  environment: "{{ pulumi_env | default({}) }}"
  vars:
    # ç¢ºä¿é€™è£¡ä½¿ç”¨ç³»çµ±çš„ AWS CLIï¼Œä¸å— Python ç’°å¢ƒå½±éŸ¿
    ansible_python_interpreter: "/usr/bin/python3" 
  when: update_kubeconfig | default(true)

- name: Ensure namespaces exist
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig | expanduser }}"
    context: "{{ kubecontext | default(omit, true) }}"
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ item }}"
  environment: "{{ pulumi_env | default({}) }}"
  loop:
    - "{{ argocd_namespace }}"
    - "{{ eso_namespace }}"
    - "{{ reloader_namespace }}"

- name: Add Argo Helm repo
  kubernetes.core.helm_repository:
    name: argo
    repo_url: https://argoproj.github.io/argo-helm
    state: present
  # âš ï¸ å¾ˆé‡è¦ï¼šé¿å…ä½ å…¶ä»– task æœ‰ become é€ æˆ repo åŠ åˆ°ä¸åŒ HOME
  become: false

- name: Update Helm repo cache
  ansible.builtin.command: /usr/sbin/helm repo update
  changed_when: false
  become: false

- name: Install ArgoCD
  kubernetes.core.helm:
    kubeconfig: "{{ kubeconfig }}"
    name: argocd
    chart_ref: argo/argo-cd
    release_namespace: "{{ argocd_namespace }}"
    chart_version: "{{ argocd_chart_version | default('9.1.7') }}"
    update_repo_cache: yes
    values:
      # è³‡æºå„ªåŒ–ï¼šé–‹ç™¼ç’°å¢ƒé—œé–‰ HA
      redis-ha:
        enabled: "{{ argocd_ha_enabled | default(false) }}"
      controller:
        replicas: "{{ 1 if not (argocd_ha_enabled | default(false)) else 2 }}"
      repoServer:
        replicas: "{{ 1 if not (argocd_ha_enabled | default(false)) else 2 }}"
      applicationSet:
        replicas: "{{ 1 if not (argocd_ha_enabled | default(false)) else 2 }}"
      
      # ç¶²è·¯è¨­å®šï¼šç›´æ¥é–‹ LoadBalancer æ–¹ä¾¿é€£ç·š
      server:
        service:
          type: "{{ argocd_service_type | default('LoadBalancer') }}"
        # ç¦æ­¢ Helm å®‰è£æ™‚è‡ªå¸¶çš„ Ingressï¼Œé¿å…è·Ÿæˆ‘å€‘è‡ªå·±çš„ Ingress Controller æ‰“æ¶
        ingress:
          enabled: false
  environment: "{{ pulumi_env | default({}) }}"
  when: argocd_enabled | default(true)

- name: Add External Secrets Helm repo
  kubernetes.core.helm_repository:
    name: external-secrets
    repo_url: https://charts.external-secrets.io
    state: present
  become: false

- name: Update Helm repo cache
  ansible.builtin.command: /usr/sbin/helm repo update
  changed_when: false
  become: false

- name: Install External Secrets Operator
  kubernetes.core.helm:
    kubeconfig: "{{ kubeconfig | expanduser }}"
    name: external-secrets
    chart_ref: external-secrets/external-secrets
    release_namespace: "{{ eso_namespace }}"
    chart_version: "{{ eso_chart_version | default('1.1.0') }}"
    values:
      installCRDs: true # é‡è¦ï¼šè‡ªå‹•å®‰è£ CRD
      serviceAccount:
        create: true
        name: "{{ eso_service_account | default('external-secrets-sa') }}"
        # ğŸš¨ é—œéµï¼šæ³¨å…¥ AWS IRSA Role ARN
        # é€™è®“ ESO Pod æœ‰æ¬Šé™å»è®€å– AWS Systems Manager (SSM)
        annotations:
          eks.amazonaws.com/role-arn: "{{ eso_irsa_role_arn }}"
      
      # è®“ Webhook ä¹Ÿè·‘åœ¨ host network é¿å…ä¸€äº› CNI å»¶é²å•é¡Œ (å¯é¸)
      webhook:
        hostNetwork: false
  environment: "{{ pulumi_env | default({}) }}"
  when: eso_enabled | default(true)

- name: Add Stakater Helm repo
  kubernetes.core.helm_repository:
    name: "{{ reloader_repo_name | default('stakater') }}"
    repo_url: "{{ reloader_repo_url | default('https://stakater.github.io/stakater-charts') }}"
    state: present
  become: false

- name: Update Helm repo cache
  ansible.builtin.command: /usr/sbin/helm repo update
  changed_when: false
  become: false

- name: Install Reloader
  kubernetes.core.helm:
    kubeconfig: "{{ kubeconfig | expanduser }}"
    name: reloader
    chart_ref: stakater/reloader
    release_namespace: "{{ reloader_namespace }}" # é€šå¸¸æ”¾åœ¨å·¥å…·é¡ namespace
    values:
      # è®“å®ƒç›£æ§æ‰€æœ‰ Namespaces è£¡çš„ ConfigMap/Secret è®Šæ›´
      reloader:
        watchGlobally: true
  environment: "{{ pulumi_env | default({}) }}"
  when: reloader_enabled | default(true)