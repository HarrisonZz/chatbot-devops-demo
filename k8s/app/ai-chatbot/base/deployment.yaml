apiVersion: apps/v1
kind: Deployment
metadata:
  name: ai-chatbot-app
  annotations:
    reloader.stakater.com/auto: "true"
  labels:
    app: ai-chatbot
    app.kubernetes.io/name: ai-chatbot
    app.kubernetes.io/part-of: ai-chatbot
spec:
  replicas: 1
  # ğŸš¨ å¿…å¡«ï¼šSelector å¿…é ˆè·Ÿä¸‹é¢çš„ template labels å°ä¸Š
  selector:
    matchLabels:
      app: ai-chatbot
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1
  template:
    metadata:
      labels:
        app: ai-chatbot
      annotations:
        instrumentation.opentelemetry.io/inject-python: "adot-instrumentation"
    spec:
      # ğŸš¨ ç¶å®šèº«ä»½ï¼šè®“ Pod æ“æœ‰ Bedrock æ¬Šé™
      serviceAccountName: ai-chatbot-sa
      containers:
        - name: ai-chatbot-app
          # ä½ çš„ ECR Image
          image: 533267110761.dkr.ecr.ap-northeast-1.amazonaws.com/ai-chatbot-app-dev:v0.1.0
          imagePullPolicy: Always # é–‹ç™¼éšæ®µå»ºè­° Alwaysï¼Œç”Ÿç”¢ç’°å¢ƒå¯æ”¹ IfNotPresent
          command: ["opentelemetry-instrument"] 
          args: [
            "streamlit", 
            "run", 
            "app.py", 
            "--server.port", "8501", 
            "--server.address", "0.0.0.0"
          ]
          
          # æš´éœ² Port (Streamlit é è¨­æ˜¯ 8501)
          ports:
            - containerPort: 8501
              name: http
          envFrom:
            - secretRef:
                name: ai-chatbot-config
          # ç’°å¢ƒè®Šæ•¸
          env:
            - name: AWS_REGION
              value: "ap-northeast-1"
            # è®“ Python log å³æ™‚è¼¸å‡ºï¼Œä¸è¦ç·©å­˜ (å°çœ‹ Log å¾ˆé‡è¦)
            - name: PYTHONUNBUFFERED
              value: "1"
            # å¦‚æœæ˜¯ Streamlitï¼Œå»ºè­°æ˜ç¢ºæŒ‡å®š Server Address
            - name: STREAMLIT_SERVER_ADDRESS
              value: "0.0.0.0"

          # è³‡æºé™åˆ¶ (å»ºè­°è¨­å®šï¼Œé¿å… Pod åƒå…‰ç¯€é»è³‡æº)
          resources:
            requests:
              cpu: "250m"    # 0.25 vCPU
              memory: "512Mi"
            limits:
              cpu: "500m"    # 0.5 vCPU
              memory: "1Gi"

          # å­˜æ´»æª¢æŸ¥ï¼šå¦‚æœä¸é€šéï¼ŒK8s æœƒé‡å•Ÿ Pod
          livenessProbe:
            tcpSocket:
              port: 8501
            initialDelaySeconds: 10
            periodSeconds: 20

          # å°±ç·’æª¢æŸ¥ï¼šé€šéå¾Œ Service æ‰æœƒæŠŠæµé‡å°é€²ä¾†
          readinessProbe:
            httpGet:
              path: /_stcore/health # Streamlit çš„å…§å»ºå¥åº·æª¢æŸ¥è·¯å¾‘
              port: 8501
            initialDelaySeconds: 5
            periodSeconds: 10